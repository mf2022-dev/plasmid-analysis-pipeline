/*
========================================================================================
    PlasmidScope - Nextflow Configuration
========================================================================================
*/

// Pipeline manifest
manifest {
    name            = 'PlasmidScope'
    author          = 'Majed Alghoribi'
    homePage        = 'https://github.com/alghoribima/plasmid-analysis-pipeline'
    description     = 'Comprehensive bacterial plasmid genomic analysis pipeline'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.04.0'
    version         = '1.0.0'
}

// ========================================================================================
//    DEFAULT PARAMETERS
// ========================================================================================

params {
    // Input/Output
    input                = null
    outdir               = './results'

    // Assembly
    assembly_mode        = 'hybrid'    // 'hybrid', 'long', 'short', 'auto', 'skip'
    skip_assembly        = false
    min_contig_length    = 500

    // Annotation
    bakta_db             = null         // Path to Bakta database
    genus                = 'Klebsiella'
    species              = 'pneumoniae'

    // Replicon Typing
    plasmidfinder_db     = 'enterobacteriaceae'
    plasmidfinder_cov    = 0.60
    plasmidfinder_id     = 0.95

    // AMR Detection
    amrfinder_organism   = 'Klebsiella_pneumoniae'

    // MGE Analysis
    skip_mge             = false
    isfinder_identity    = 90
    isfinder_evalue      = '1e-10'

    // Visualization
    skip_viz             = false
    reference            = null         // Reference plasmid for BRIG comparison

    // Comparative
    mash_threshold       = 0.04         // Mash distance threshold for clustering

    // Resource limits
    max_cpus             = 32
    max_memory           = '128.GB'
    max_time             = '72.h'

    // MultiQC
    multiqc_config       = null

    // Boilerplate
    help                 = false
    tracedir             = "${params.outdir}/pipeline_info"
}

// ========================================================================================
//    PROFILES
// ========================================================================================

profiles {

    standard {
        process.executor = 'local'
    }

    docker {
        docker.enabled         = true
        docker.userEmulation   = true
        singularity.enabled    = false
        podman.enabled         = false
    }

    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false
        podman.enabled         = false
    }

    conda {
        conda.enabled          = true
        docker.enabled         = false
        singularity.enabled    = false
    }

    slurm {
        process.executor       = 'slurm'
        process.queue          = 'normal'
        process.clusterOptions = '--account=default'
    }

    pbs {
        process.executor       = 'pbs'
        process.queue          = 'normal'
    }

    sge {
        process.executor       = 'sge'
    }

    test {
        params.input           = "${projectDir}/test/samplesheet_test.csv"
        params.outdir          = './test_results'
        params.max_cpus        = 4
        params.max_memory      = '8.GB'
        params.max_time        = '2.h'
    }

    test_full {
        params.input           = "${projectDir}/test/samplesheet_full.csv"
        params.outdir          = './test_full_results'
    }
}

// ========================================================================================
//    PROCESS CONFIGURATION
// ========================================================================================

process {

    // Default resources
    cpus   = { check_max( 2 * task.attempt, 'cpus' ) }
    memory = { check_max( 4.GB * task.attempt, 'memory' ) }
    time   = { check_max( 4.h * task.attempt, 'time' ) }

    errorStrategy = { task.exitStatus in [143,137,104,134,139,140] ? 'retry' : 'finish' }
    maxRetries    = 2
    maxErrors     = '-1'

    // Process-specific resources
    withName: 'FASTQC' {
        cpus   = { check_max( 4, 'cpus' ) }
        memory = { check_max( 4.GB, 'memory' ) }
    }

    withName: 'FASTP' {
        cpus   = { check_max( 8, 'cpus' ) }
        memory = { check_max( 8.GB, 'memory' ) }
    }

    withName: 'UNICYCLER' {
        cpus   = { check_max( 16 * task.attempt, 'cpus' ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 24.h * task.attempt, 'time' ) }
    }

    withName: 'FLYE' {
        cpus   = { check_max( 16 * task.attempt, 'cpus' ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 12.h * task.attempt, 'time' ) }
    }

    withName: 'HYBRACTER' {
        cpus   = { check_max( 16 * task.attempt, 'cpus' ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 24.h * task.attempt, 'time' ) }
    }

    withName: 'BAKTA' {
        cpus   = { check_max( 8 * task.attempt, 'cpus' ) }
        memory = { check_max( 16.GB * task.attempt, 'memory' ) }
        time   = { check_max( 4.h * task.attempt, 'time' ) }
    }

    withName: 'MOB_SUITE' {
        cpus   = { check_max( 8, 'cpus' ) }
        memory = { check_max( 16.GB, 'memory' ) }
    }

    withName: 'INTEGRON_FINDER' {
        cpus   = { check_max( 8, 'cpus' ) }
        memory = { check_max( 8.GB, 'memory' ) }
    }

    withName: 'MASH_DIST' {
        cpus   = { check_max( 8, 'cpus' ) }
        memory = { check_max( 8.GB, 'memory' ) }
    }
}

// ========================================================================================
//    CONTAINER DEFINITIONS
// ========================================================================================

process {
    withName: 'FASTQC'                { container = 'biocontainers/fastqc:0.12.1--hdfd78af_0' }
    withName: 'NANOPLOT'              { container = 'biocontainers/nanoplot:1.42.0--pyhdfd78af_0' }
    withName: 'FASTP'                 { container = 'biocontainers/fastp:0.23.4--hadf994f_0' }
    withName: 'FILTLONG'              { container = 'biocontainers/filtlong:0.2.1--he4a0461_0' }
    withName: 'UNICYCLER'             { container = 'biocontainers/unicycler:0.5.0--py39h2add14b_2' }
    withName: 'FLYE'                  { container = 'biocontainers/flye:2.9.3--py39h6935b12_0' }
    withName: 'QUAST'                 { container = 'biocontainers/quast:5.2.0--py39pl5321h4e691d4_3' }
    withName: 'BAKTA'                 { container = 'oschwengers/bakta:1.9.3' }
    withName: 'ABRICATE'              { container = 'biocontainers/abricate:1.0.1--ha8f3691_2' }
    withName: 'AMRFINDERPLUS'         { container = 'biocontainers/ncbi-amrfinderplus:3.12.8--h283d18e_0' }
    withName: 'PLASMIDFINDER'         { container = 'genomicepidemiology/plasmidfinder:2.1' }
    withName: 'MOB_SUITE'             { container = 'biocontainers/mob_suite:3.1.8--pyhdfd78af_0' }
    withName: 'INTEGRON_FINDER'       { container = 'biocontainers/integron_finder:2.0.3--pyhdfd78af_0' }
    withName: 'MOBILE_ELEMENT_FINDER' { container = 'biocontainers/mobile_element_finder:1.1.2--pyhdfd78af_0' }
    withName: 'CLINKER'               { container = 'biocontainers/clinker-py:0.0.28--pyhdfd78af_0' }
    withName: 'MULTIQC'               { container = 'biocontainers/multiqc:1.21--pyhdfd78af_0' }
}

// ========================================================================================
//    REPORTING
// ========================================================================================

timeline {
    enabled = true
    file    = "${params.tracedir}/execution_timeline.html"
}
report {
    enabled = true
    file    = "${params.tracedir}/execution_report.html"
}
trace {
    enabled = true
    file    = "${params.tracedir}/execution_trace.txt"
}
dag {
    enabled = true
    file    = "${params.tracedir}/pipeline_dag.svg"
}

// ========================================================================================
//    FUNCTIONS
// ========================================================================================

def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "WARNING: Max memory '${params.max_memory}' is not valid. Using default."
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "WARNING: Max time '${params.max_time}' is not valid. Using default."
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "WARNING: Max cpus '${params.max_cpus}' is not valid. Using default."
            return obj
        }
    }
}
